<!doctype html>
<html lang="ca">
<head>
<link rel="stylesheet" type="text/css" href="base.css" />
<link rel="stylesheet" type="text/css" href="exe_highlighter.css" />
<link rel="stylesheet" type="text/css" href="content.css" />
<link rel="stylesheet" type="text/css" href="nav.css" />
<meta http-equiv="content-type" content="text/html;  charset=utf-8" />
<title>3. Simplificant l'accés a la base de dades </title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="license" type="text/html" href="http://creativecommons.org/licenses/by-sa/4.0/" />
<meta name="generator" content="eXeLearning  - exelearning.net" />
<!--[if lt IE 9]><script type="text/javascript" src="exe_html5.js"></script><![endif]-->
<script type="text/javascript" src="exe_jquery.js"></script>
<script type="text/javascript" src="exe_highlighter.js"></script>
<script type="text/javascript" src="common_i18n.js"></script>
<script type="text/javascript" src="common.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body class="exe-web-site" id="exe-node-3"><script type="text/javascript">document.body.className+=" js"</script>
<div id="content">
<p id="skipNav"><a href="#main" class="sr-av">Omet navegació</a></p>
<section id="emptyHeader"></section>
<nav id="siteNav">
<ul>
   <li><a href="index.html" class="daddy main-node">Inici</a></li>
   <li><a href="1_maneig_de_phpmyadmin.html" class="no-ch">1. Maneig de PHPMyAdmin</a></li>
   <li><a href="2_accs_a_la_base_de_dades_mitjanant_php_amb_la_llibreria_pdoema.html" class="daddy">2. Accés a la base de dades mitjançant PHP amb la llibreria PDOema</a>
   <ul class="other-section">
      <li><a href="21_connexi_a_la_base_de_dades.html" class="no-ch">2.1. Connexió a la base de dades</a></li>
      <li><a href="22_execuci_de_consultes.html" class="no-ch">2.2. Execució de consultes</a></li>
      <li><a href="23_consultes_preparades.html" class="no-ch">2.3. Consultes preparades</a></li>
      <li><a href="24_inserci_modificaci_i_eliminaci_de_dades_de_la_bbdd.html" class="no-ch">2.4. Inserció, modificació i eliminació de dades de la BBDD</a></li>
      <li><a href="25_gesti_derrors_en_laccs.html" class="no-ch">2.5. Gestió d'errors en l'accés</a></li>
      <li><a href="exercicis_prctics.html" class="no-ch">Exercicis pràctics</a></li>
   </ul>
   </li>
   <li id="active"><a href="3_simplificant_laccs_a_la_base_de_dades.html" class="active daddy">3. Simplificant l'accés a la base de dades</a>
   <ul>
      <li><a href="exercicis_prctics0.html" class="no-ch">Exercicis pràctics</a></li>
   </ul>
   </li>
   <li><a href="4_transaccions.html" class="no-ch">4. Transaccions</a></li>
</ul>
</nav>
<div id='topPagination'>
<nav class="pagination noprt">
<a href="exercicis_prctics.html" class="prev"><span><span>&laquo; </span>Anterior</span></a> <span class="sep">| </span><a href="exercicis_prctics0.html" class="next"><span>Següent<span> &raquo;</span></span></a>
</nav>
</div>
<div id="main-wrapper">
<section id="main">
<header id="nodeDecoration"><h1 id="nodeTitle">3. Simplificant l'accés a la base de dades</h1></header>
<article class="iDevice_wrapper FreeTextIdevice" id="id8">
<div class="iDevice emphasis0">
<div id="ta8_85" class="block iDevice_content">
<h2>Arxiu de configuració</h2>
<p>És important que totes les dades de configuració que siguin susceptibles de canviar en els diferents entorns (desenvolupament, producció, test, etc.) es separen en un o diversos fitxers de configuració.</p>
<p>Aquests fitxers es poden codificar en PHP o utilitzar un altre format que després pugui ser llegit per PHP (Per exemple, ara s'utilitza molt YAML)</p>
<p>Per exemple</p>
<div class="highlighted-code language-php">
<div>
<pre><code>#config.php
$config = array (
    'database' =&gt; array (
        'name' =&gt; 'blog',
        'username' =&gt; 'blog',
        'password' =&gt; 'blog',
        'connection' =&gt; 'mysql: host=blog.local, dbname=blog',
        'options' =&gt; array ()
        )
    )
);</code></pre>
</div>
</div>
<p>En format JSON:</p>
<div class="highlighted-code language-json">
<div>
<pre><code>{
  "database": {
    "username": "blog",
    "password": "blog",
    "connection": "mysql: host=blog.local; dbname=blog",
    "options": {
    }
  }
}</code></pre>
</div>
</div>
<h2>Creació de les entitats i la interfície a la base de dades</h2>
<p>Anomenarem entitats a les classes que mapejaran les taules de la base de dades, tindran un atribut per cada camp de la taula que mapegen.</p>
<p>En la majoria dels casos només contindran:</p>
<ul>
<li>getters i setters per accedir als atributs.</li>
<li>Constructor si cal.</li>
<li>__toString per convertir l'objecte a cadena.</li>
<li>Etc.</li>
</ul>
<p>No implementarem lògica de negoci en les entitats.</p>
<p>Les querys que obtindran dades de la BBDD tornaran un array d'entitats</p>
<p>Per exemple:</p>
<div class="highlighted-code language-php">
<div>
<pre><code>class Book
{
    private $id;
    private $isbn;
    private $title;
    private $author;
    private $stock;
    private $price;

    public function getId(): int
    {
        return $this-&gt;id;
    }

    public function getIsbn(): string
    {
        return $this-&gt;isbn;
    }

    public function getTitle(): string
    {
        return $this-&gt;title;
    }

    public function getAuthor(): string
    {
        return $this-&gt;author;
    }

    public function getStock(): int
    {
        return $this-&gt;stock;
    }

    public function getCopy(): bool
    {
        if ($this-&gt;stock &lt; 1) {
            return false;
        } else {
            $this-&gt;stock--;
            return true;
        }
    }

    public function addCopy()
    {
        $this-&gt;stock++;
    }

    public function getPrice(): float
    {
        return $this-&gt;price;
    }
}
</code></pre>
</div>
</div>
<p>Tant el mètode fetch com el mètode fetchAll de la classe PDOStatement tenen la possibilitat de retornar les dades de la BBDD com a objectes de la classe que li indiquem.</p>
<p>Utilitzarem el paràmetre PDO::FETCH_CLASS passant el nom de l'entitat com a segon paràmetre.</p>
<div class="highlighted-code language-php">
<div>
<pre><code>$classEntity = 'Post';
$posts= $stmt-&gt; fetchAll (PDO::FETCH_CLASS, $classEntity);</code></pre>
</div>
</div>
<p>En aquest cas, obtindríem un array que conté totes les files del conjunt de resultats com a objectes de l'entitat Post</p>
<p>Veure documentació del mètode:</p>
<ul>
<li><a href="https://www.php.net/manual/es/pdostatement.fetchall.php">https://www.php.net/manual/es/pdostatement.fetchall.php</a></li>
</ul>
<p>Cal tenir en compte que si la classe té constructor caldrà emprar el 3 paràmetre del mètode i afegir-los mitjançant un <code>array</code> i en el primer paràmetre afegir <em>PDO::FETCH_PROPS_LATE.</em></p>
<p><code><em></em></code></p>
<p></p>
<div class="highlighted-code language-php">
<div>
<pre><code>class Persona
{
    private $name;

    public function __construct(string $name)
    {
        $this-&gt;name = $name;
        $this-&gt;decir();
    }

    public function decir()
    {
        if (isset($this-&gt;name)) {
            echo "Soy {$this-&gt;name}.\n";
        } else {
            echo "Aún no tengo nombre.\n";
        }
    }
}

$sth = $dbh-&gt;query("SELECT * FROM people"); // El name del primer és Paco.
$sth-&gt;setFetchMode(PDO::FETCH_CLASS, 'Persona', ['Alicia']); // Soy Paco
$persona = $sth-&gt;fetch(); 
$persona-&gt;decir();

$sth-&gt;setFetchMode(PDO::FETCH_CLASS|PDO::FETCH_PROPS_LATE, 'Persona', ['Alicia']); // Soy Alícia
$persona = $sth-&gt;fetch(); 
$persona-&gt;decir();</code></pre>
</div>
</div>
<p><br /><br /></p>
<h2>Contenidors de serveis</h2>
<p>Un contenidor de serveis (o contenidor d'injecció de dependències) simplement és un objecte PHP que gestiona la creació d'instàncies dels serveis (és a dir, dels objectes).</p>
<p>Suposem per exemple que tens una classe PHP senzilla que envia missatges de correu electrònic. Sense un contenidor de serveis, has de crear manualment l'objecte cada vegada que ho necessitis:</p>
<div class="highlighted-code language-php">
<div>
<pre><code>use Acme\HelloBundle\Mailer;

$mailer = new Mailer ( 'sendmail');
$mailer-&gt; send ('ryan@foobar.net ', ...);</code></pre>
</div>
</div>
<p>Aquest codi és bastant fàcil, ja que la classe imaginària Mailer s'encarrega de configurar el mètode utilitzat per enviar missatges de correu electrònic (per exemple, sendmail, smtp, etc.). Què passa si has d'utilitzar la classe Mailer en un altre punt de l'aplicació? Has de copiar i enganxar el mateix codi en tots els llocs? I si has de canviar la forma en què s'envien els correus electrònics? Has de buscar en el codi de tota l'aplicació i canviar la mateixa configuració desenes de vegades?</p>
<h2>Repositori d'entitats o models.</h2>
<h2>Gestió de les relacions.</h2>
</div>
</div>
</article>
<div id="packageLicense" class="cc cc-by-sa">
<p><span>Llicenciat sota la </span> <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Llicència Creative Commons Reconeixement CompartirIgual 4.0</a></p>
</div>
</section>
</div>
<div id='bottomPagination'>
<nav class="pagination noprt">
<a href="exercicis_prctics.html" class="prev"><span><span>&laquo; </span>Anterior</span></a> <span class="sep">| </span><a href="exercicis_prctics0.html" class="next"><span>Següent<span> &raquo;</span></span></a>
</nav>
</div>
</div>
<script type="text/javascript" src="_intef_js.js"></script></body></html>